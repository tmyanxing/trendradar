name: TrendRadar WeChat Push

on:
  schedule:
    # GitHub Actions æ—¶é—´åŸºäº UTCï¼ŒåŒ—äº¬æ—¶é—´ = UTC + 8
    # å½“å‰é…ç½®ï¼šåŒ—äº¬æ—¶é—´ 9:00ã€12:00ã€18:00 å„æ‰§è¡Œä¸€æ¬¡
    # UTC 1:00 = åŒ—äº¬ 9:00
    # UTC 4:00 = åŒ—äº¬ 12:00
    # UTC 10:00 = åŒ—äº¬ 18:00
    - cron: "0 1,4,10 * * *"
  workflow_dispatch:
    # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ

# æ·»åŠ æƒé™è®¾ç½®ï¼Œç”¨äºæäº¤æ›´æ–°
permissions:
  contents: write

jobs:
  crawl-and-push:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: 'pip'  # ç¼“å­˜ pip ä¾èµ–ï¼ŒåŠ é€Ÿåç»­è¿è¡Œ

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify required files
        run: |
          echo "ğŸ” æ£€æŸ¥å¿…éœ€çš„é…ç½®æ–‡ä»¶..."

          if [ ! -f config/config.yaml ]; then
            echo "âŒ é”™è¯¯: config/config.yaml æ–‡ä»¶ä¸å­˜åœ¨"
            echo "è¯·å‚è€ƒé¡¹ç›®æ–‡æ¡£åˆ›å»ºé…ç½®æ–‡ä»¶"
            exit 1
          fi

          if [ ! -f config/frequency_words.txt ]; then
            echo "âŒ é”™è¯¯: config/frequency_words.txt æ–‡ä»¶ä¸å­˜åœ¨"
            echo "è¯·å‚è€ƒé¡¹ç›®æ–‡æ¡£åˆ›å»ºé¢‘ç‡è¯é…ç½®æ–‡ä»¶"
            exit 1
          fi

          echo "âœ… é…ç½®æ–‡ä»¶æ£€æŸ¥é€šè¿‡"

      - name: Run TrendRadar Crawler
        env:
          # ä¼ä¸šå¾®ä¿¡æœºå™¨äºº Webhook URLï¼ˆå¿…éœ€ï¼‰
          # è¯·åœ¨ GitHub ä»“åº“ Settings -> Secrets and variables -> Actions ä¸­æ·»åŠ 
          WEWORK_WEBHOOK_URL: ${{ secrets.WEIXINROBOT }}
          # æ ‡è®°ä¸º GitHub Actions ç¯å¢ƒ
          GITHUB_ACTIONS: true
          # å¯é€‰ï¼šè¦†ç›–é…ç½®æ–‡ä»¶ä¸­çš„è®¾ç½®
          # ENABLE_CRAWLER: true
          # ENABLE_NOTIFICATION: true
          # REPORT_MODE: daily  # å¯é€‰: daily | incremental | current
        run: |
          echo "ğŸš€ å¼€å§‹è¿è¡Œ TrendRadar çˆ¬è™«..."
          echo "ğŸ“… å½“å‰æ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰: $(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S')"
          python main.py

      - name: Commit and push if changes
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add -A
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´ï¼Œæœ‰åˆ™æäº¤æ¨é€
          if git diff --quiet && git diff --staged --quiet; then
            echo "ğŸ“ æ²¡æœ‰æ–°çš„å˜æ›´éœ€è¦æäº¤"
          else
            git commit -m "ğŸ¤– Auto update by TrendRadar at $(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S')"
            git push
            echo "âœ… å˜æ›´å·²æäº¤å¹¶æ¨é€"
          fi
